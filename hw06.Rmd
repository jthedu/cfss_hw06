---
title: "HW06: Income Data"
author: "Julia Du"
date: "2/18/2021"
output: 
  github_document:
    toc: true
---

```{r setup, echo=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

## Load necessary libraries

```{r, echo = FALSE}
library(reprex)
library(tidyverse)
library(glue)
library(knitr)
library(lubridate)

theme_set(theme_minimal())
```

# Get the Data

I used Tidy Tuesday's [02/09/2021 challenge data](https://github.com/rfordatascience/tidytuesday/tree/master/data/2021/2021-02-09). This particular challenge comes from the Urban Institute and looks at income inequality. I also am using a dataset of presidents and their term length [here](https://gist.github.com/namuol/2657233).

Run [this script](download-hw06.R) to download the data for this .Rmd.

# Simplifying (not tidying) Data

The income data is already tidy, but I am further simplifying some of it for easier analysis. 

Originally, student_debt.csv (in column loan_debt) and retirement.csv (retirement) are in 2016 dollars, but the income_mean.csv (income_dollars) is in 2019 dollars. For consistency, I'm normalizing all data to 2019 dollars, using [inflation rate info](https://www.calculator.net/inflation-calculator.html?cstartingamount1=1&cinyear1=2016&coutyear1=2019&calctype=1&x=83&y=13) based off average annual CPI data in the U.S. from 1914 to 2020.

I am also simplifying datasets so that possible race values are only white, non-white Hispanic, Black alone, or Asian alone.


```{r simplify}
# rate between 2016 & 2019 dollars
start_2016 <- 1.05940

# normalize dollar amounts to 2019
student_debt <- student_debt %>%
  mutate(loan_debt = loan_debt * start_2016)

retirement <- retirement %>%
  mutate(retirement = retirement *start_2016)

# renaming middle quintile to "Third" for future df joining 
# & keeping only 2019 dollar amounts
income_mean <- income_mean %>%
  filter(dollar_type == "2019 Dollars") %>%
  mutate(income_quintile = if_else(income_quintile == "Middle", "Third", income_quintile))

# reordering income quintile levels & simplify race values
income_leveled <- c("Lowest", "Second", "Third", "Fourth", "Highest", "Top 5%")

level_simple_data <- function(df) {
  df %>%
  mutate(income_quintile = factor(income_quintile, levels = income_leveled)) %>%
  filter(!race %in% c("Asian Alone or in Combination", "Black Alone or in Combination", "White Alone"))
}

income_aggregate <- level_simple_data(income_aggregate) 
income_mean <- level_simple_data(income_mean)

# DELETE THIS BIT
#normalize <- function(df, column) {
 # mutate(!! {{column}} := {{column}} * 2)
#}
```

# Analyzing the Data

## Exploring Broad Income Trends

```{r}
# income share over time
income_aggregate %>%
  filter(race == "All Races") %>%
  ggplot(mapping = aes(x = year, y = income_share/100, color = income_quintile, group = income_quintile)) +
  geom_line() +
  scale_y_continuous(labels = scales::percent) +
    labs(title = "Income Share of each Income Group over Time",
       x = "Year", y = "Percentage of income share",
       caption = "Source: The Urban Institute", color = "Income Quintile")

# mean income over time
income_mean %>%
  filter(race == "All Races") %>%
  ggplot(mapping = aes(x = year, y = income_dollars, color = income_quintile, group = income_quintile)) +
  geom_line() +
  labs(title = "Mean Income of each Income Group over Time",
       x = "Year", y = "Mean income (2019 dollars)",
       caption = "Source: The Urban Institute", color = "Income Quintile") +
  scale_y_continuous(labels = scales::dollar)
```

## Exploring Income by Race

```{r}
# mean income for quintile by race
income_mean %>%
  ggplot(mapping = aes(x = income_quintile, y = income_dollars, fill = income_quintile)) +
  geom_violin() +
  geom_boxplot(width = 0.9, color = "grey", alpha = 0.3) +
  facet_wrap(race ~ .) +
    scale_y_continuous(labels = scales::dollar) +
  labs(title = "Mean Income of each Income Group across Race",
       x = "", y = "Mean income (2019 dollars)",
       caption = "Source: The Urban Institute",
       fill = "Income Quintile") +
  theme(axis.text.x = element_blank()) +
  theme(legend.position = "bottom") +
  guides(fill = guide_legend(nrow = 1))

# mean income overall by race
income_mean %>%
  filter(income_quintile == "Third") %>%
    group_by(year, race) %>%
  ggplot(mapping = aes(x = year, y = income_dollars, color = race)) +
  geom_point(alpha = .3) + 
  geom_smooth(method = lm, se = FALSE) +
  scale_color_viridis_d(option = "plasma", end = .7) +
  labs(title = "Median Average Income by Race over Time",
       x = "Year", y = "Average income (2019 dollars)",
       caption = "Source: The Urban Institute", color = "Race") +
  scale_y_continuous(labels = scales::dollar)
```

## Other Metrics of Economic Inequality Across Race

```{r, message = FALSE}
# creating comparable mean income table 
meaninc_compare <- income_mean %>% 
  filter(income_quintile == "Third") %>%
  mutate(race = if_else(race == "Black Alone", "Black", race)) %>%
  mutate(race = ifelse(race == "White, Not Hispanic", "White", race))

meaninc_compare %>%
  inner_join(student_debt, by = c("year", "race")) %>%
  inner_join(retirement, by = c("year", "race")) %>%
  group_by(race) %>%
  summarize(mean(income_dollars), mean(loan_debt), mean(retirement)) %>%
  knitr::kable(
    caption = "Averages of Economic Inequality Metrics (2019 dollars)", 
    col.names = c(
      "Race",
      "Mean income", 
      "Loan debt", 
      "Retirement savings"),
    digits = 2)

compare_inc <- function(df, var){
meaninc_compare %>% 
  inner_join({df}, by = c("year", "race")) %>%
  ggplot(mapping = aes(x = income_dollars, y = {{var}}, color = race)) +
  geom_point(alpha = .3) + 
  geom_smooth(method = lm, se = FALSE) +
    scale_color_viridis_d(end = .7) +
  scale_x_continuous(labels = scales::dollar) +
    theme(legend.position = "bottom")
}

# retirement
compare_inc(retirement, retirement) +
  labs(title = "Median Average Income vs. Average Retirement Savings", 
       subtitle = "(2019 dollars)",
       x = "Average family income", y = "Average family retirement savings",
       caption = "Source: The Urban Institute",
       color = "Race") +
  scale_y_continuous(labels = scales::dollar) 


# student debt
compare_inc(student_debt, loan_debt) +
  labs(title = "Median Average Income vs. Average Student Loan Debt", 
       subtitle = "(2019 dollars)",
       x = "Average family income", y = "Average family student loan debt for aged 25-55",
       caption = "Source: The Urban Institute",
       color = "Race") +
  scale_y_continuous(labels = scales::dollar)

# homeownership
compare_inc(home_owner, home_owner_pct) +
  labs(title = "Median Average Income vs. Home Ownership",
       x = "Average family income (2019 dollars)", y = "Home ownership percentage for families",
       caption = "Source: The Urban Institute",
       color = "Race") +
  scale_y_continuous(labels = scales::percent)
```

## Percentages of Home Ownership & Student Loan Debt

```{r}
home_owner %>% 
  inner_join(student_debt, by = c("year", "race")) %>%
  select(-loan_debt) %>%
  pivot_longer(c(home_owner_pct, loan_debt_pct), 
               names_to = "type", values_to = "percentages") %>%
#  mutate(type = if_else())
  ggplot(mapping = aes(x = race, fill = type)) +
  geom_boxplot(aes(y = percentages)) +  
  labs(title = "Home Ownership and Loan Debt in Families",
       x = "Race", y = "Percentage of families",
       caption = "Source: The Urban Institute",
       fill = "") +
  scale_fill_discrete(labels = c("Home ownership", "Student loan debt")) +
  scale_y_continuous(labels = scales::percent) +
  theme(legend.position = "bottom")

```


## Median Average Income & Presidents

```{r president, message = FALSE}
pres_levels <- c("Lyndon B. Johnson", "Richard Nixon", "Gerald Ford", "Jimmy Carter", "Ronald Reagan", "George H. W. Bush", "Bill Clinton", "George W. Bush", "Barack Obama", "Donald Trump")

president <- president %>%
  rename(
    start = "Took office", 
    end = "Left office",
    name = "President"
    ) %>%
  select(c(name, start, end)) %>%
  mutate(start = dmy(start), end = dmy(end)) %>%
  mutate(start = year(start), end = year(end)) %>%
  mutate(end = if_else(is.na(end), 2017, end)) %>%
  add_row(name = "Donald Trump", start = 2017, end = 2021) %>%
  filter(end > 1967) %>%
  mutate(name = fct_relevel(name, pres_levels))

pres_income_df <- income_mean %>%
  filter(race == "All Races",
         income_quintile == "Third") %>%
  group_by(year)

med_income_line <- pres_income_df %>%
  ggplot(mapping = aes(x = year, y = income_dollars)) +
  geom_line() +
  labs(title = "Median Average U.S. Income",
       x = "Year", y = "Average income (2019 dollars)",
       caption = "Source: The Urban Institute") +
  scale_y_continuous(label = scales::dollar)

# this is the mean income of the middle quintile of US

med_income_line + 
  geom_rect(data = president, 
            mapping = aes(NULL, NULL, xmin = start, xmax = end, 
                          ymin = min(pres_income_df$income_dollars), 
                          ymax = max(pres_income_df$income_dollars), 
                          fill = name), 
            alpha = 0.2) +
  labs(fill = "President")   
```