---
title: "HW06: Income Data"
author: "Julia Du"
date: "2/18/2021"
output: 
  github_document:
    toc: true
---

```{r setup, echo=FALSE}
#knitr::opts_chunk$set(echo = TRUE)

```

## Load necessary libraries

```{r, echo = FALSE}
library(reprex)
library(tidyverse)
library(glue)
library(knitr)
library(lubridate)

theme_set(theme_minimal())
```

# Get the Data
I used Tidy Tuesday's [02/09/2021 challenge data](https://github.com/rfordatascience/tidytuesday/tree/master/data/2021/2021-02-09). This particular challenge comes from the Urban Institute and looks at racial wealth inequality over time.

*income_time*

```{r, message = FALSE, warning = FALSE}
student_debt <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2021/2021-02-09/student_debt.csv')
#retirement <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2021/2021-02-09/retirement.csv')
home_owner <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2021/2021-02-09/home_owner.csv')
#race_wealth <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2021/2021-02-09/race_wealth.csv')
income_aggregate <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2021/2021-02-09/income_aggregate.csv')
income_mean <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2021/2021-02-09/income_mean.csv')

```

simplified some datasets to only focus on white, non-white hispanic, black alone, asian alone

The data provided here has been normalized to 2016 dollars in some datasets and to 2019 dollars in others. For consistency's sake, I will normalize all dollar amounts to 2019 dollars, using [inflation rate info](https://www.calculator.net/inflation-calculator.html?cstartingamount1=1&cinyear1=2016&coutyear1=2019&calctype=1&x=83&y=13) based off average annual CPI data in the U.S. from 1914 to 2020.

Currently, student_debt.csv (loan_debt), retirement.csv (retirement), and race_wealth.csv (wealth_family) are in 2016 dollars. 

income_mean.csv (income_dollars) is in 2019 dollars.


```{r cleanup}
income_mean <- income_mean %>%
  filter(dollar_type == "2019 Dollars") %>%
  mutate(income_quintile = if_else(income_quintile == "Middle", "Third", income_quintile))

#reordering inc quint levels
income_leveled <- c("Lowest", "Fourth", "Third", "Second", "Highest", "Top 5%")

level_simple_data <- function(df) {
  df %>%
  mutate(income_quintile = factor(income_quintile, levels = income_leveled)) %>%
  filter(!race %in% c("Asian Alone or in Combination", "Black Alone or in Combination", "White Alone"))
}

income_aggregate <- level_simple_data(income_aggregate) 
income_mean <- level_simple_data(income_mean)


# only keeping values normalized to 2019 & renaming middle quintile to "Third" for future df joining 

# purchasing power rates
start_2016 <- 1.05940

normalize <- function(df, column) {
  df %>%
    mutate({column} = {{column}} * start_2016) 
  #alternatively: mutate({{column}} = {{column}} * start_2016)
}


#student_debt 
  normalize(df = student_debt, column = loan_debt)

retirement <- normalize(retirement, retirement)

    #    mutate(glue_data("norm_{column}") := {{column}} * start_2016) 
    #  rename(glue('normalized_{{column}}') = {{normalized}})

  # per tidyverse rules, have to use {{}} to indicate I'm choosing a column 
  # https://dplyr.tidyverse.org/articles/programming.html 

# possible to write func so that normalized column name is "normalized_column"
```


```{r}
# visualizing aggregate income
# recall: each income quintile has the same # of ppl in it

### compare # of households to income_share

income_aggregate %>%
  filter(race == "All Races") %>%
  ggplot(mapping = aes(x = year, y = income_share/100, color = income_quintile, group = income_quintile)) +
  geom_line() +
  scale_y_continuous(labels = scales::percent) +
    labs(title = "Income Share by Income Group Over Time",
       x = "Year", y = "Percentage of income share",
       caption = "Source: The Urban Institute", color = "Income Quintile")

income_mean %>%
  filter(race == "All Races") %>%
  ggplot(mapping = aes(x = year, y = income_dollars, color = income_quintile, group = income_quintile)) +
  geom_line() +
  labs(title = "Mean Income of Each Income Quintile Over Time",
       x = "Year", y = "Mean income (in normalized 2019 dollars)",
       caption = "Source: The Urban Institute", color = "Income Quintile") 


income_aggregate %>%
#  inner_join(income_mean, by = c("year", "race", "income_quintile")) %>% 
  ggplot(mapping = aes(x = income_quintile, y = income_share/100, fill = income_quintile)) +
  geom_violin() +
  facet_wrap(race ~ .) +
    scale_y_continuous(labels = scales::percent) +
  labs(title = "Income Share Across Race",
       x = "", y = "Percentage of Income Share",
       caption = "Source: The Urban Institute",
       fill = "Income Quintile") +
  theme(axis.text.x = element_blank())
# so historically, highest income_quintile has had greatest share of income
# should you even be making this graph?


income_mean %>% #creating comparable income_mean df for retirement, debt, homeowner
  filter(income_quintile == "Third") %>%
  mutate(race = if_else(race == "Black Alone", "Black", race)) %>%
  mutate(race = ifelse(race == "White, Not Hispanic", "White", race)) %>% #would stop here if want to make this its own obj
  inner_join(retirement, by = c("year", "race")) %>%
  ggplot(mapping = aes(x = income_dollars, y = retirement, color = race)) +
  geom_line() +
  labs(title = "Mean Family Income vs. Retirement Savings (normalized 2019 dollars)",
       x = "Average family income", y = "Average family retirement savings",
       caption = "Source: The Urban Institute",
       color = "Income Quintile") 
```

```{r}
home_owner %>% 
  inner_join(student_debt, by = c("year", "race")) %>%
  ggplot(mapping = aes(x = home_owner_pct, y = loan_debt_pct, fill = race)) +
  #geom_line()
  geom_boxplot()

#home ownership over the yrs
home_owner %>%
  group_by(year, race) %>%
  ggplot(mapping = aes(x = year, y = home_owner_pct, color = race)) +
#  geom_col(position = position_dodge2(width = 0.9, preserve = "single"))
  geom_line()
```



```{r}
# comparing mean income of median quintile of racial groups over the yrs

income_mean %>%
  filter(
    dollar_type == "2019 Dollars", #already did this earlier in set-up
    income_quintile == "Third" # was originally "Middle" but then renamed this value
    ) %>%
    group_by(year, race) %>%
  ggplot(mapping = aes(x = year, y = income_dollars, color = race)) +
  #geom_line() +
  geom_point(alpha = .3) + 
  geom_smooth(method = lm, se = FALSE) +
  scale_color_viridis_d(option = "plasma", end = .7)

```



```{r president}
pres_levels <- c("Lyndon B. Johnson", "Richard Nixon", "Gerald Ford", "Jimmy Carter", "Ronald Reagan", "George H. W. Bush", "Bill Clinton", "George W. Bush", "Barack Obama", "Donald Trump")

president <- president %>%
  rename(
    start = "Took office", 
    end = "Left office",
    name = "President"
    ) %>%
  select(c(name, start, end)) %>%
  mutate(start = dmy(start), end = dmy(end)) %>%
  mutate(start = year(start), end = year(end)) %>%
  mutate(end = if_else(is.na(end), 2017, end)) %>%
  add_row(name = "Donald Trump", start = 2017, end = 2021) %>%
  filter(end > 1967) %>%
  mutate(name = fct_relevel(name, pres_levels))


pres_income_df <- income_mean %>%
  filter(race == "All Races",
         income_quintile == "Third") %>%
  group_by(year)

med_income_line <- pres_income_df %>%
  ggplot(mapping = aes(x = year, y = income_dollars)) +
  geom_line() +
  labs(title = "Mean U.S. income over time",
       x = "Year", y = "Mean income (normalized 2019 dollars)",
       caption = "Source: The Urban Institute") 

# this is the mean income of the middle quintile of US

med_income_line + 
  geom_rect(data = president, 
            mapping = aes(NULL, NULL, xmin = start, xmax = end, 
                          ymin = min(pres_income_df$income_dollars), ymax = max(pres_income_df$income_dollars), 
                          fill = name), 
            alpha = 0.3) +
  labs(fill = "President") +
  theme(legend.position = "bottom")

# makes sense. can see income tumbled during Carter's term (stagflation of 1970s) as well as 1st part of Obama's term (08 financial crisis)
```